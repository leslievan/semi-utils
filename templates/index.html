<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'spin-slow': 'spin 1s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.24.1/ace.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.24.1/mode-json.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0" crossorigin="anonymous"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .ace_editor {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .tree-node {
            transition: all 0.15s ease;
        }

        .tree-node:hover {
            background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 h-screen w-full flex flex-col overflow-hidden text-sm"
      x-data="app()" x-init="init()">

<!-- 顶部导航 -->
<header class="glass-effect border-b border-slate-200/50 h-16 flex items-center px-6 shadow-sm shrink-0 z-20">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-primary-500/30">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        </div>
        <div>
            <h1 class="font-bold text-lg text-slate-800 tracking-tight">{{ title }}</h1>
            <p class="text-xs text-slate-400">v{{version}}</p>
        </div>
    </div>
</header>

<!-- 主布局 -->
<main class="flex-1 p-5 overflow-hidden">
    <div class="grid grid-cols-12 gap-5 h-full">

        <!-- Col 1: 配置管理 -->
        <div class="col-span-12 lg:col-span-3 flex flex-col h-full bg-white/80 backdrop-blur rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 overflow-hidden animate-fade-in">
            <div class="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h3 class="font-bold text-slate-700">配置管理</h3>
                </div>
                <span class="text-xs px-2.5 py-1 rounded-full font-medium transition-all duration-200"
                      :class="isStatic ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'"
                      x-text="isStatic ? '已保存' : '编辑中'"></span>
            </div>

            <div class="p-5 flex-1 overflow-y-auto space-y-4">
                <div class="space-y-1">
                    <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wide">输入文件夹</label>
                    <div class="relative">
                        <input type="text" x-model="config.input_folder" :disabled="isStatic"
                               class="w-full h-10 pl-10 pr-4 rounded-xl border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-all disabled:bg-slate-50 disabled:text-slate-400 text-sm">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wide">输出文件夹</label>
                    <div class="relative">
                        <input type="text" x-model="config.output_folder" :disabled="isStatic"
                               class="w-full h-10 pl-10 pr-4 rounded-xl border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-all disabled:bg-slate-50 disabled:text-slate-400 text-sm">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wide">输出质量: <span x-text="config.quality" class="text-primary-600 font-bold"></span>%</label>
                    <div class="flex items-center gap-3">
                        <input type="range" x-model="config.quality" :disabled="isStatic"
                               min="60" max="100" step="1"
                               class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-primary-500 disabled:opacity-50">
                        <input type="number" x-model="config.quality" :disabled="isStatic"
                               min="60" max="100" step="1"
                               class="w-16 h-10 px-3 text-center rounded-xl border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-all disabled:bg-slate-50">
                    </div>
                </div>

                <div class="flex-1 min-h-[300px]">
                    <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wide mb-2">模板配置 (JSON)</label>
                    <div id="json-editor" class="w-full h-full min-h-[300px] rounded-xl"></div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                <template x-if="isStatic">
                    <button @click="enableEdit()"
                            class="w-full py-2.5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-xl font-medium shadow-lg shadow-primary-500/30 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        编辑配置
                    </button>
                </template>
                <template x-if="!isStatic">
                    <div class="flex gap-2">
                        <button @click="resetConfig()"
                                class="flex-1 py-2.5 border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-xl font-medium transition-all duration-200">
                            取消
                        </button>
                        <button @click="saveConfig()"
                                class="flex-1 py-2.5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white rounded-xl font-medium shadow-lg shadow-primary-500/30 transition-all duration-200">
                            保存配置
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Col 2: 文件树 -->
        <div class="col-span-12 lg:col-span-6 flex flex-col h-full bg-white/80 backdrop-blur rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 overflow-hidden animate-slide-up" style="animation-delay: 0.1s">
            <div class="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    <h3 class="font-bold text-slate-700">文件列表</h3>
                </div>
                <button @click="fetchFiles()"
                        class="p-2 rounded-lg hover:bg-primary-50 text-slate-400 hover:text-primary-600 transition-all duration-200">
                    <svg class="w-5 h-5" :class="{'animate-spin': loading.files}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>

            <div class="flex-1 overflow-hidden p-5 flex flex-col">

                <!-- 输入树 -->
                <div class="flex-1 flex flex-col min-h-0 overflow-hidden">
                    <div class="flex items-center justify-between mb-2 pb-2 border-b border-slate-100 shrink-0">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">输入文件</span>
                            <span class="text-xs px-2 py-0.5 bg-primary-100 text-primary-700 rounded-full font-medium"
                                  x-text="`${selectedItems.length} 已选中`"></span>
                        </div>
                        <button @click="selectAll()" class="text-xs text-primary-600 hover:text-primary-700 font-medium">全选</button>
                    </div>

                    <div class="flex-1 overflow-y-auto pr-2">
                        <!-- Loading -->
                        <div x-show="loading.files" class="flex flex-col items-center justify-center py-12 text-slate-400">
                            <svg class="animate-spin h-8 w-8 text-primary-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm">正在扫描文件系统...</span>
                        </div>

                        <!-- Empty -->
                        <div x-show="!loading.files && (!inputTreeData || inputTreeData.length === 0)"
                             class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 16h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm text-slate-400">未找到文件</span>
                        </div>

                        <!-- Tree -->
                        <div x-show="!loading.files && inputTreeData && inputTreeData.length > 0" class="space-y-1">
                            <template x-for="(node, index) in inputTreeData" :key="node.value || node.label || index">
                                <div x-data="treeNode(node, true)" class="tree-item">
                                    <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                         :style="'padding-left: 8px'"
                                         @click="handleClick()">
                                        <input type="checkbox"
                                               class="mr-2 w-4 h-4 text-primary-600 rounded border-slate-300 focus:ring-2 focus:ring-primary-500/20 cursor-pointer"
                                               :checked="isChecked"
                                               @click.stop="toggle()">
                                        <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                            <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </span>
                                        <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                        <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                        <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                    </div>
                                    <div class="children" x-show="isOpen && hasChildren">
                                        <template x-for="(child, childIndex) in node.children" :key="child.value || child.label || childIndex">
                                            <div x-data="treeNode(child, true)" class="tree-item">
                                                <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                                     :style="'padding-left: 24px'"
                                                     @click="handleClick()">
                                                    <input type="checkbox"
                                                           class="mr-2 w-4 h-4 text-primary-600 rounded border-slate-300 focus:ring-2 focus:ring-primary-500/20 cursor-pointer"
                                                           :checked="isChecked"
                                                           @click.stop="toggle()">
                                                    <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                                        <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </span>
                                                    <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                                    <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                                    <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                                </div>
                                                <div class="children" x-show="isOpen && hasChildren">
                                                    <template x-for="(grandchild, grandIndex) in child.children" :key="grandchild.value || grandchild.label || grandIndex">
                                                        <div x-data="treeNode(grandchild, true)" class="tree-item">
                                                            <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                                                 :style="'padding-left: 40px'"
                                                                 @click="handleClick()">
                                                                <input type="checkbox"
                                                                       class="mr-2 w-4 h-4 text-primary-600 rounded border-slate-300 focus:ring-2 focus:ring-primary-500/20 cursor-pointer"
                                                                       :checked="isChecked"
                                                                       @click.stop="toggle()">
                                                                <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                                                    <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                </span>
                                                                <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                                                <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                                                <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                                            </div>
                                                            <div class="children" x-show="isOpen && hasChildren">
                                                                <template x-for="(ggchild, ggIndex) in grandchild.children" :key="ggchild.value || ggchild.label || ggIndex">
                                                                    <div x-data="treeNode(ggchild, true)" class="tree-item">
                                                                        <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                                                             :style="'padding-left: 56px'"
                                                                             @click="handleClick()">
                                                                            <input type="checkbox"
                                                                                   class="mr-2 w-4 h-4 text-primary-600 rounded border-slate-300 focus:ring-2 focus:ring-primary-500/20 cursor-pointer"
                                                                                   :checked="isChecked"
                                                                                   @click.stop="toggle()">
                                                                            <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                                                                <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                                                                </svg>
                                                                            </span>
                                                                            <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                                                            <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                                                            <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- 输出树 -->
                <div class="flex-1 flex flex-col min-h-0 overflow-hidden mt-4">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-100 shrink-0">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">输出文件</span>
                    </div>
                    <div class="flex-1 overflow-y-auto pr-2">
                        <div x-show="!loading.files && outputTreeData && outputTreeData.length > 0" class="space-y-1">
                            <template x-for="node in outputTreeData" :key="node.value || node.label">
                                <div x-data="treeNode(node, false)" class="tree-item">
                                    <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                         :style="'padding-left: 8px'"
                                         @click="handleClick()">
                                        <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                            <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </span>
                                        <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                        <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                        <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                    </div>
                                    <div class="children" x-show="isOpen && hasChildren">
                                        <template x-for="child in node.children" :key="child.value || child.label">
                                            <div x-data="treeNode(child, false)" class="tree-item">
                                                <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                                     :style="'padding-left: 24px'"
                                                     @click="handleClick()">
                                                    <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                                        <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </span>
                                                    <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                                    <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                                    <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                                </div>
                                                <div class="children" x-show="isOpen && hasChildren">
                                                    <template x-for="grandchild in child.children" :key="grandchild.value || grandchild.label">
                                                        <div x-data="treeNode(grandchild, false)" class="tree-item">
                                                            <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                                                 :style="'padding-left: 40px'"
                                                                 @click="handleClick()">
                                                                <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                                                    <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                </span>
                                                                <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                                                <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                                                <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                                            </div>
                                                            <div class="children" x-show="isOpen && hasChildren">
                                                                <template x-for="ggchild in grandchild.children" :key="ggchild.value || ggchild.label">
                                                                    <div x-data="treeNode(ggchild, false)" class="tree-item">
                                                                        <div class="tree-node flex items-center py-2 px-2 rounded-lg cursor-pointer select-none"
                                                                             :style="'padding-left: 56px'"
                                                                             @click="handleClick()">
                                                                            <span class="mr-2 flex items-center justify-center w-3" @click.stop="toggleFolder()" x-show="hasChildren" style="display: none;">
                                                                                <svg class="w-3 h-3 transition-transform duration-200" :class="isOpen ? 'rotate-90' : ''" fill="currentColor" viewBox="0 0 20 20">
                                                                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                                                                </svg>
                                                                            </span>
                                                                            <span class="mr-2" x-show="hasChildren" x-html="folderIcon"></span>
                                                                            <span class="mr-2" x-show="!hasChildren" x-html="fileIcon"></span>
                                                                            <span class="flex-1 text-xs font-medium text-slate-700 truncate" x-text="label"></span>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Col 3: 预览与执行 -->
        <div class="col-span-12 lg:col-span-3 flex flex-col h-full gap-5">

            <!-- 预览卡片 -->
            <div class="flex-1 bg-white/80 backdrop-blur rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 flex flex-col overflow-hidden animate-slide-up" style="animation-delay: 0.2s">
                <div class="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <h3 class="font-bold text-slate-700">图片预览</h3>
                    </div>
                </div>

                <div class="flex-1 bg-gradient-to-br from-slate-50 to-slate-100/50 flex items-center justify-center p-4 relative overflow-hidden">
                    <!-- Empty -->
                    <div x-show="!preview.url || !preview.isFile" class="text-center">
                        <div class="w-20 h-20 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                            <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <span class="text-xs text-slate-400">点击文件预览</span>
                    </div>

                    <!-- Image -->
                    <div x-show="preview.url && preview.isFile"
                         class="w-full h-full flex flex-col"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform scale-95"
                         x-transition:enter-end="opacity-100 transform scale-100">
                        <div class="text-xs text-center text-slate-500 mb-2 font-mono truncate bg-white/90 backdrop-blur py-1.5 px-3 rounded-xl border border-slate-200 shadow-sm"
                             x-text="preview.name"></div>
                        <div class="flex-1 relative rounded-xl border border-slate-200 bg-white shadow-lg overflow-hidden">
                            <img x-effect="if(preview.isFile) $el.src = preview.url"
                                 class="absolute inset-0 w-full h-full object-contain p-2">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作卡片 -->
            <div class="bg-white/80 backdrop-blur rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 p-5 shrink-0 relative overflow-hidden animate-slide-up" style="animation-delay: 0.3s">

                <!-- Loading Overlay -->
                <div x-show="loading.process"
                     class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm rounded-2xl">
                    <div class="w-10 h-10 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mb-3"></div>
                    <span class="text-sm font-bold text-primary-600">处理中...</span>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-bold text-slate-800" x-text="selectedItems.length">0</span>
                            <span class="text-sm text-slate-400">/ 待处理</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs px-3 py-1.5 rounded-xl font-medium transition-all duration-200"
                              :class="isValidConfig ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'"
                              x-text="isValidConfig ? '配置有效' : '需保存配置'"></span>
                    </div>
                </div>

                <button @click="startProcess()"
                        :disabled="!canStart"
                        class="w-full py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    开始执行
                </button>
                <p class="mt-2 text-center text-xs text-slate-400" x-show="!canStart">请保存配置并选择文件</p>
            </div>
        </div>
    </div>
</main>

<script>
    function treeNode(node, isInput) {
        return {
            node: node,
            isInput: isInput,
            isOpen: true,

            get isFile() {
                return !!this.node.is_file;
            },

            get hasChildren() {
                return this.node.children && this.node.children.length > 0;
            },

            get value() {
                return this.node.value || this.node.key;
            },

            get label() {
                return this.node.label || this.node.title || this.node.name;
            },

            get isChecked() {
                if (this.isFile) {
                    return window.Alpine.store('app').selectedItems.includes(this.value);
                }
                return this.areAllChildrenSelected(this.node);
            },

            areAllChildrenSelected(node) {
                if (!node.children) return false;
                return node.children.every(child => {
                    if (child.is_file) {
                        return window.Alpine.store('app').selectedItems.includes(child.value || child.key);
                    }
                    return this.areAllChildrenSelected(child);
                });
            },

            getAllFileValues(node) {
                let paths = [];
                if (node.is_file) {
                    paths.push(node.value || node.key);
                } else if (node.children) {
                    node.children.forEach(child => {
                        paths = paths.concat(this.getAllFileValues(child));
                    });
                }
                return paths;
            },

            toggle() {
                const app = window.Alpine.store('app');
                const targetValues = this.getAllFileValues(this.node);

                if (this.isChecked) {
                    app.selectedItems = app.selectedItems.filter(v => !targetValues.includes(v));
                } else {
                    app.selectedItems = [...new Set([...app.selectedItems, ...targetValues])];
                }
            },

            handleClick() {
                if (this.isFile) {
                    // 文件：显示预览
                    const app = window.Alpine.store('app');
                    app.preview.url = `/api/v1/file?path=${encodeURIComponent(this.value)}`;
                    app.preview.name = this.label;
                    app.preview.isFile = true;
                } else if (this.hasChildren) {
                    // 文件夹：切换折叠状态
                    this.toggleFolder();
                }
            },

            toggleFolder() {
                if (this.hasChildren) {
                    this.isOpen = !this.isOpen;
                }
            },

            get folderIcon() {
                return `<svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                </svg>`;
            },

            get fileIcon() {
                return `<svg class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>`;
            }
        }
    }

    function app() {
        return {
            isStatic: true,
            loading: {files: false, process: false},
            config: {input_folder: '', output_folder: '', template: '{}', quality: 100},
            inputTreeData: [],
            outputTreeData: [],
            selectedItems: [],
            preview: {url: '', name: '', isFile: false},
            aceEditor: null,

            get isValidConfig() {
                return this.isStatic;
            },

            get canStart() {
                return this.isStatic && this.selectedItems.length > 0 && !this.loading.process;
            },

            async init() {
                Alpine.store('app', this);
                this.initEditor();

                this.toast = (msg, type = 'info') => {
                    Toastify({
                        text: msg,
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        style: {
                            background: type === 'error' ? "#ef4444" : (type === 'success' ? "#10b981" : "#3b82f6"),
                            borderRadius: "12px",
                            fontSize: "14px",
                            fontWeight: "500",
                            boxShadow: "0 10px 15px -3px rgba(0, 0, 0, 0.1)",
                            padding: "12px 24px"
                        }
                    }).showToast();
                };

                await this.fetchConfig();
                await this.fetchFiles();
            },

            initEditor() {
                this.aceEditor = ace.edit("json-editor");
                this.aceEditor.setTheme("ace/theme/textmate");
                this.aceEditor.session.setMode("ace/mode/json");
                this.aceEditor.setShowPrintMargin(false);
                this.aceEditor.setReadOnly(true);

                this.aceEditor.on('change', () => {
                    this.config.template = this.aceEditor.getValue();
                });
            },

            enableEdit() {
                this.isStatic = false;
                this.aceEditor.setReadOnly(false);
                this.aceEditor.container.style.backgroundColor = "#fff";
            },

            async resetConfig() {
                await this.fetchConfig();
            },

            async fetchConfig() {
                try {
                    const res = await fetch('/api/v1/config');
                    const json = await res.json();
                    const data = this.normalizeApiResponse(json);

                    if (data) {
                        this.config = {...data};
                        let tplStr = typeof this.config.template === 'object' ?
                            JSON.stringify(this.config.template, null, 2) :
                            this.config.template;

                        this.aceEditor.setValue(tplStr || '{}', -1);
                        this.isStatic = true;
                        this.aceEditor.setReadOnly(true);
                        this.aceEditor.container.style.backgroundColor = "#f9fafb";
                    }
                } catch (e) {
                    this.toast("获取配置失败: " + e.message, 'error');
                }
            },

            async saveConfig() {
                const jsonVal = this.aceEditor.getValue();
                try {
                    JSON.parse(jsonVal);
                } catch (e) {
                    this.toast("JSON 格式错误", 'error');
                    return;
                }

                try {
                    const res = await fetch('/api/v1/config', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({...this.config, template: jsonVal})
                    });

                    if (res.ok) {
                        this.isStatic = true;
                        this.aceEditor.setReadOnly(true);
                        this.toast("配置已保存", 'success');
                        this.fetchFiles(true);
                    } else {
                        throw new Error("服务端错误");
                    }
                } catch (e) {
                    this.toast("保存失败: " + e.message, 'error');
                }
            },

            async fetchFiles(renderInput=true) {
                this.loading.files = true;

                try {
                    const res = await fetch('/api/v1/file/tree');
                    const json = await res.json();
                    const data = this.normalizeApiResponse(json);

                    const allCurrentFileValues = new Set();
                    const collectValues = (node) => {
                        if (node.is_file) {
                            allCurrentFileValues.add(node.value || node.key);
                        }
                        if (node.children) {
                            node.children.forEach(collectValues);
                        }
                    };

                    if (data.input_files) {
                        data.input_files.forEach(collectValues);
                        this.selectedItems = this.selectedItems.filter(v => allCurrentFileValues.has(v));

                        if (renderInput) {
                            this.inputTreeData = data.input_files || [];
                        }
                        this.outputTreeData = data.output_files || [];
                    }
                } catch (e) {
                    this.toast("文件列表加载失败", 'error');
                } finally {
                    this.loading.files = false;
                }
            },

            selectAll() {
                const collectAllFiles = (nodes) => {
                    let files = [];
                    nodes.forEach(node => {
                        if (node.is_file) {
                            files.push(node.value || node.key);
                        } else if (node.children) {
                            files = files.concat(collectAllFiles(node.children));
                        }
                    });
                    return files;
                };

                const allFiles = collectAllFiles(this.inputTreeData);
                this.selectedItems = [...new Set([...this.selectedItems, ...allFiles])];
            },

            async startProcess() {
                this.loading.process = true;
                try {
                    const res = await fetch('/api/v1/start_process', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({selectedItems: this.selectedItems})
                    });
                    if (res.ok) {
                        this.toast("执行成功!", 'success');
                        this.fetchFiles(false);
                    } else {
                        this.toast("执行异常", 'error');
                    }
                } catch (e) {
                    this.toast("网络请求失败", 'error');
                } finally {
                    this.loading.process = false;
                }
            },

            normalizeApiResponse(json) {
                if (json && json.data && json.status === 0) return json.data;
                if (json && json.data) return json.data;
                return json;
            }
        }
    }
</script>
</body>
</html>