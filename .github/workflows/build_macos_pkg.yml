name: Build macOS Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  EXIFTOOL_URL: https://github.com/leslievan/fastfiles/raw/refs/heads/main/exiftool/Image-ExifTool-13.45.tar.gz
  PACKAGE_BASENAME: semi-utils
  PLATFORM: macos-x64

jobs:
  build-and-package:
    name: Build and Package for Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository source code into 'dist'
        uses: actions/checkout@v4
        with:
          path: dist

      - name: Download ExifTool
        run: |
          echo "Downloading ExifTool from ${{ env.EXIFTOOL_URL }}"
          curl -L ${{ env.EXIFTOOL_URL }} -o exiftool.tar.gz

      - name: Extract ExifTool to 'dist/exiftool'
        run: |
          mkdir -p dist/exiftool
          tar -xzf exiftool.tar.gz -C dist/exiftool --strip-components=1

      - name: Clean up temporary files
        run: rm exiftool.tar.gz

      - name: Verify package structure
        run: |
          echo "Final package structure in 'dist':"
          ls -R dist

      - name: Determine Artifact Name
        id: artifact_name
        shell: bash
        run: |
          TAG=${{ github.ref_name }}
          
          if [[ $TAG == v* ]]; then
            CLEAN_TAG=${TAG#v}
          else
            CLEAN_TAG=${{ github.sha }}
            CLEAN_TAG=${CLEAN_TAG:0:7}
          fi
          
          ARTIFACT_NAME="${{ env.PACKAGE_BASENAME }}-${CLEAN_TAG}-${{ env.PLATFORM }}"
          echo "Generated Artifact Name: ${ARTIFACT_NAME}"
          echo "artifact_name=${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.artifact_name }}
          path: dist

